---
title: "Transcriptomics Analysis with rmatt"
author: "Matthew Muller"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_float: true
    code_folding: show
    theme: flatly
    highlight: tango
bibliography: references.bib
vignette: >
  %\VignetteIndexEntry{Transcriptomics Analysis with rmatt}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 8,
  fig.height = 6,
  message = FALSE,
  warning = FALSE
)
```

# Introduction

The `rmatt` package provides a comprehensive suite of tools for transcriptomics analysis, from data preprocessing and normalization to differential expression analysis, enrichment analysis, and visualization. This vignette demonstrates a complete transcriptomics workflow using the key functions available in the package.

## Overview of Analysis Steps

1. **Data Import and Preprocessing**
   - Reading count data from FeatureCounts
   - Quality control and filtering
   - Creating DESeq2 objects

2. **Exploratory Data Analysis**
   - Library size and depth visualization
   - Principal component analysis
   - Sample clustering

3. **Differential Expression Analysis**
   - DESeq2, limma-voom, and Wilcoxon rank-sum tests
   - Multiple comparison correction
   - Volcano plots and MA plots

4. **Gene Set Enrichment Analysis**
   - GO term enrichment
   - KEGG pathway analysis
   - Custom gene set analysis

5. **Advanced Analysis**
   - Correlation analysis
   - Clustering and dimensionality reduction
   - Signature analysis

Let's start by loading the necessary libraries:

```{r libraries}
library(rmatt)
library(DESeq2)
library(tidyverse)

# Set random seed for reproducibility
set.seed(123)

```

# Data Import and Preprocessing

## Reading Count Data

The `rmatt` package provides convenient functions for reading count data from various sources. The most common scenario is reading FeatureCounts output:

```{r data_import, eval=FALSE}
# Read count data from FeatureCounts output directory
count_table <- CountTableFromFeatureCounts(
  directory = "path/to/featurecounts/output",
  pattern = "featureCounts.txt$",
  idx = 7  # Column containing count data
)

# Alternatively, read individual FeatureCounts files
single_file <- ReadFeatureCounts(
  f = "sample1.featureCounts.txt",
  idx = 7
)
```

For demonstration purposes, let's create a simulated dataset:

```{r simulate_data}
# Create simulated count data for demonstration
set.seed(123)
# Mock data creation for testing
create_mock_counts <- function(n_genes = 100, n_samples = 6) {
  set.seed(42)
  counts <- matrix(rpois(n_genes * n_samples, lambda = 10),
    nrow = n_genes, ncol = n_samples
  )
  library(org.Hs.eg.db)
  gene_ids <- keys(org.Hs.eg.db, keytype = "ENTREZID")
  selected_genes <- sample(gene_ids, n_genes)
  gene_symbols <- mapIds(org.Hs.eg.db, keys = selected_genes, column = "SYMBOL", keytype = "ENTREZID", multiVals = "first")
  rownames(counts) <- gene_symbols
  colnames(counts) <- paste0("sample", 1:n_samples)
  return(counts)
}

create_mock_dds <- function(n_genes = 100, n_samples = 6) {
  counts <- create_mock_counts(n_genes, n_samples)
  coldata <- data.frame(
    condition = factor(rep(c("A", "B"), each = n_samples/2)),
    batch = factor(rep(c("1", "2", "3"), each = 2)),
    row.names = colnames(counts)
  )
  return(DESeqDataSetFromMatrix(counts, coldata, design = ~ condition))
}

# Simulate a DESeq2 object
dds <- create_mock_dds(n_genes = 100, n_samples = 6)
print(dds)
```

## Quality Control and Filtering

We start with quality control and filtering of the count data which are packed into the `rna_preprocessing` function.

```{r qc_filtering}
# Run the preprocessing steps
dds_filtered <- rna_preprocessing(dds)
```

# Differential Expression Analysis

## DESeq2 Analysis

The primary method for differential expression analysis in `rmatt` uses DESeq2:

```{r deseq_analysis}

# Run DESeq2 analysis pipeline
condition <- "condition"
controls <- "batch"
deseq_out <- deseq_analysis(
  dds = dds_filtered,
  condition = condition,
  controls = controls
)

```

